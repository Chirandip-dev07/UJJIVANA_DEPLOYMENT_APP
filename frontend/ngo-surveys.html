<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Surveys - Ujjivana Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .survey-card {
            border-left: 4px solid #28a745;
            transition: all 0.3s;
        }
        .survey-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .submission-item {
            border-left: 3px solid #17a2b8;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .question-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        /* Analytics Styles */
        .analytics-tab {
            min-height: 400px;
        }
        .chart-bar {
            margin-bottom: 15px;
        }
        .chart-bar .d-flex {
            margin-bottom: 5px;
        }
        .chart-bar .progress {
            height: 25px;
        }
        .survey-completion-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .survey-completion-item:last-child {
            border-bottom: none;
        }
        .insight-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .insight-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
        .peak-time-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .analytics-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
        }
        /* Chart colors for different categories */
        .category-waste-reduction { background-color: #17a2b8; }
        .category-energy-conservation { background-color: #ffc107; }
        .category-water-preservation { background-color: #007bff; }
        .category-sustainable-living { background-color: #28a745; }
        .category-biodiversity { background-color: #6f42c1; }
        .category-climate-action { background-color: #e83e8c; }
        /* Enhanced Mobile Responsive Styles */
@media (max-width: 768px) {
    /* Navigation adjustments */
    .navbar-nav {
        text-align: center;
        margin-top: 10px;
    }
    
    .navbar-collapse {
        padding: 10px 0;
    }
    
    /* Container padding adjustment */
    .container {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    /* Header adjustments */
    .container.py-4 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
    }
    
    /* Statistics cards - stack vertically */
    .stats-card {
        margin-bottom: 15px;
        padding: 15px;
    }
    
    .stats-card .fa-2x {
        font-size: 1.5rem !important;
    }
    
    /* Analytics dashboard adjustments */
    .analytics-tab {
        min-height: auto;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    /* Table responsiveness */
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .table-responsive table {
        min-width: 600px;
    }
    
    /* Button group adjustments */
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    /* Modal adjustments */
    .modal-dialog {
        margin: 0.5rem;
    }
    
    .modal-content {
        border-radius: 0.5rem;
    }
    
    /* Form adjustments */
    .form-control, .form-select {
        font-size: 16px; /* Prevents zoom on iOS */
    }
    
    /* Chart and progress bar adjustments */
    .chart-bar .progress {
        height: 20px;
    }
    
    .survey-completion-item {
        padding: 6px 0;
    }
    
    /* Analytics header buttons */
    .card-header .btn-group {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .card-header .btn-group .btn {
        margin-bottom: 5px;
    }
    
    /* Hide less important elements on mobile */
    .d-none-mobile {
        display: none !important;
    }
}

@media (max-width: 576px) {
    /* Extra small devices */
    .container {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    /* Statistics numbers */
    .stats-card h3 {
        font-size: 1.5rem;
    }
    
    /* Card padding reduction */
    .card-body {
        padding: 0.75rem;
    }
    
    /* Button sizes */
    .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Modal full width on very small screens */
    .modal-dialog {
        margin: 0;
        max-width: none;
    }
    
    /* Analytics tabs - vertical stack */
    .analytics-tab .row > div {
        margin-bottom: 1rem;
    }
    
    /* Progress bars in analytics */
    .progress {
        height: 15px !important;
    }
    
    /* Survey completion items */
    .survey-completion-item .small {
        font-size: 0.75rem;
    }
    
    /* Hide welcome text in navbar */
    .navbar-text {
        display: none;
    }
}

/* Enhanced Mobile-First Styles */
@media (max-width: 360px) {
    /* Very small screens */
    .container {
        padding-left: 5px;
        padding-right: 5px;
    }
    
    .stats-card {
        padding: 10px;
    }
    
    .stats-card h3 {
        font-size: 1.25rem;
    }
    
    .btn-group-vertical {
        width: 100%;
    }
    
    .btn-group-vertical .btn {
        text-align: center;
    }
    
    /* Reduce font sizes further */
    .card-header h5, .card-header h6 {
        font-size: 1rem;
    }
    
    .display-4 {
        font-size: 2rem;
    }
}

/* Touch-friendly improvements */
.btn, .form-control, .form-select, .form-check-input {
    touch-action: manipulation;
}

/* Prevent horizontal scroll */
body {
    overflow-x: hidden;
}

/* Improved dropdown for mobile */
@media (max-width: 768px) {
    .dropdown-menu {
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .dropdown-item {
        padding: 0.75rem 1rem;
    }
}

/* Enhanced table responsiveness */
@media (max-width: 768px) {
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    /* Add horizontal scroll indicator */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 4px;
    }
}

/* Mobile-optimized modal forms */
@media (max-width: 576px) {
    .modal-body .row {
        margin-left: -5px;
        margin-right: -5px;
    }
    
    .modal-body .col-md-6, 
    .modal-body .col-md-4, 
    .modal-body .col-md-8 {
        padding-left: 5px;
        padding-right: 5px;
    }
    
    .question-item {
        padding: 10px;
    }
}

/* Improved button spacing for mobile */
.btn-group-sm > .btn, .btn-sm {
    margin: 1px;
}

/* Analytics chart mobile optimization */
@media (max-width: 768px) {
    #time-series-chart .d-inline-block {
        width: 35px !important;
        margin: 0 2px;
    }
    
    #time-series-chart .bg-primary {
        width: 25px !important;
    }
}

/* Peak times chart mobile optimization */
@media (max-width: 576px) {
    .peak-time-item {
        padding: 6px 0;
    }
    
    .peak-time-item .progress {
        height: 6px !important;
    }
}

/* Survey form question options mobile fix */
@media (max-width: 576px) {
    .question-options .row {
        margin-left: -5px;
        margin-right: -5px;
    }
    
    .question-options .col-md-3,
    .question-options .col-md-6 {
        padding-left: 5px;
        padding-right: 5px;
        margin-bottom: 5px;
    }
}

/* Export button mobile adjustment */
@media (max-width: 576px) {
    .card-header .btn-group {
        display: flex;
        flex-direction: column;
    }
    
    .card-header .btn-group .btn {
        margin-bottom: 5px;
        width: 100%;
    }
}

/* Statistics cards mobile grid */
@media (max-width: 768px) {
    .row.mb-4 .col-md-3 {
        margin-bottom: 15px;
    }
}

/* Analytics tabs mobile optimization */
@media (max-width: 768px) {
    .analytics-tab .card {
        margin-bottom: 1rem;
    }
    
    .analytics-tab .row.mt-4 {
        margin-top: 1rem !important;
    }
}

/* Mobile navbar brand adjustment */
@media (max-width: 576px) {
    .navbar-brand {
        font-size: 1rem;
    }
    
    .navbar-brand .fa-leaf {
        font-size: 1.1rem;
    }
}
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
    <div class="container">
        <a class="navbar-brand" href="admin-home.html">
            <i class="fas fa-leaf me-2"></i>Ujjivana
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="admin-home.html">Dashboard</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Take Actions
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="admin-reviews.html">Manage Reviews</a></li>
                        <li><a class="dropdown-item" href="admin.html">Manage Content</a></li>
                        <li><a class="dropdown-item" href="admin-rewards.html">Manage Rewards</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Tools and Utilities
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="eco-map.html">Eco Map</a></li>
                        <li><a class="dropdown-item active" href="ngo-surveys.html">NGO Surveys</a></li>
                    </ul>
                </li>
            </ul>
            <div class="dropdown user-dropdown" id="user-menu" style="display: none;">
    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" 
       data-bs-toggle="dropdown" aria-expanded="false">
        <img src="https://ui-avatars.com/api/?name=User+Name&background=27ae60&color=fff&size=32" 
             class="rounded-circle me-2" alt="Profile" width="32" height="32" id="navbar-avatar">
        <span id="navbar-username">User</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end">
        <li>
            <div class="dropdown-header text-center">
                <img src="https://ui-avatars.com/api/?name=User+Name&background=27ae60&color=fff&size=64" 
                     class="rounded-circle mb-2" alt="Profile" width="64" height="64" id="dropdown-avatar">
                <h6 class="mb-1" id="dropdown-username">User Name</h6>
                <small class="text-muted" id="dropdown-email">user@example.com</small>
                <span class="badge user-role-badge student-badge" id="dropdown-role">Student</span>
            </div>
        </li>
        
        <li>
            <a class="dropdown-item text-danger" href="#" onclick="startLogoutProcess()">
                <i class="fas fa-sign-out-alt"></i>Logout
            </a>
        </li>
    </ul>
</div>
<!-- Animated Logout Button (Initially Hidden) -->
    <div class="logout-button-container" id="logout-button-container" style="display: none;">
        <button class="animated-logout-button-nav" id="animated-logout-button">
            <svg class="doorway" viewBox="0 0 100 100">
                <path d="M93.4 86.3H58.6c-1.9 0-3.4-1.5-3.4-3.4V17.1c0-1.9 1.5-3.4 3.4-3.4h34.8c1.9 0 3.4 1.5 3.4 3.4v65.8c0 1.9-1.5 3.4-3.4 3.4z"/>
                <path class="bang" d="M40.5 43.7L26.6 31.4l-2.5 6.7zM41.9 50.4l-19.5-4-1.4 6.3zM40 57.4l-17.7 3.9 3.9 5.7z"/>
            </svg>
            <svg class="figure" viewBox="0 0 100 100">
                <circle cx="52.1" cy="32.4" r="6.4"/>
                <path d="M50.7 62.8c-1.2 2.5-3.6 5-7.2 4-3.2-.9-4.9-3.5-4-7.8.7-3.4 3.1-13.8 4.1-15.8 1.7-3.4 1.6-4.6 7-3.7 4.3.7 4.6 2.5 4.3 5.4-.4 3.7-2.8 15.1-4.2 17.9z"/>
                <g class="arm1">
                    <path d="M55.5 56.5l-6-9.5c-1-1.5-.6-3.5.9-4.4 1.5-1 3.7-1.1 4.6.4l6.1 10c1 1.5.3 3.5-1.1 4.4-1.5.9-3.5.5-4.5-.9z"/>
                    <path class="wrist1" d="M69.4 59.9L58.1 58c-1.7-.3-2.9-1.9-2.6-3.7.3-1.7 1.9-2.9 3.7-2.6l11.4 1.9c1.7.3 2.9 1.9 2.6 3.7-.4 1.7-2 2.9-3.8 2.6z"/>
                </g>
                <g class="arm2">
                    <path d="M34.2 43.6L45 40.3c1.7-.6 3.5.3 4 2 .6 1.7-.3 4-2 4.5l-10.8 2.8c-1.7.6-3.5-.3-4-2-.6-1.6.3-3.4 2-4z"/>
                    <path class="wrist2" d="M27.1 56.2L32 45.7c.7-1.6 2.6-2.3 4.2-1.6 1.6.7 2.3 2.6 1.6 4.2L33 58.8c-.7 1.6-2.6 2.3-4.2 1.6-1.7-.7-2.4-2.6-1.7-4.2z"/>
                </g>
                <g class="leg1">
                    <path d="M52.1 73.2s-7-5.7-7.9-6.5c-.9-.9-1.2-3.5-.1-4.9 1.1-1.4 3.8-1.9 5.2-.9l7.9 7c1.4 1.1 1.7 3.5.7 4.9-1.1 1.4-4.4 1.5-5.8.4z"/>
                    <path class="calf1" d="M52.6 84.4l-1-12.8c-.1-1.9 1.5-3.6 3.5-3.7 2-.1 3.7 1.4 3.8 3.4l1 12.8c.1 1.9-1.5 3.6-3.5 3.7-2 0-3.7-1.5-3.8-3.4z"/>
                </g>
                <g class="leg2">
                    <path d="M37.8 72.7s1.3-10.2 1.6-11.4 2.4-2.8 4.1-2.6c1.7.2 3.6 2.3 3.4 4l-1.8 11.1c-.2 1.7-1.7 3.3-3.4 3.1-1.8-.2-4.1-2.4-3.9-4.2z"/>
                    <path class="calf2" d="M29.5 82.3l9.6-10.9c1.3-1.4 3.6-1.5 5.1-.1 1.5 1.4.4 4.9-.9 6.3l-8.5 9.6c-1.3 1.4-3.6 1.5-5.1.1-1.4-1.3-1.5-3.5-.2-5z"/>
                </g>
            </svg>
            <svg class="door" viewBox="0 0 100 100">
                <path d="M93.4 86.3H58.6c-1.9 0-3.4-1.5-3.4-3.4V17.1c0-1.9 1.5-3.4 3.4-3.4h34.8c1.9 0 3.4 1.5 3.4 3.4v65.8c0 1.9-1.5 3.4-3.4 3.4z"/>
                <circle cx="66" cy="50" r="3.7"/>
            </svg>
            <span class="button-text">Logging Out...</span>
        </button>
    </div>
</div>
        </div>
    </div>
</nav>

    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>NGO Surveys Management</h2>
                    <button class="btn btn-success" onclick="showCreateSurveyModal()">
                        <i class="fas fa-plus me-2"></i>Create New Survey
                    </button>
                </div>
                <p class="text-muted">Manage environmental surveys for students and track submissions</p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 id="total-surveys">0</h3>
                            <p class="mb-0">Total Surveys</p>
                        </div>
                        <i class="fas fa-clipboard-list fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 id="active-surveys">0</h3>
                            <p class="mb-0">Active Surveys</p>
                        </div>
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 id="total-submissions">0</h3>
                            <p class="mb-0">Total Submissions</p>
                        </div>
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 id="total-points">0</h3>
                            <p class="mb-0">Points Distributed</p>
                        </div>
                        <i class="fas fa-coins fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Analytics Section -->
        <div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Survey Analytics Dashboard</h5>
                <div>
                    <button class="btn btn-sm btn-outline-success me-2" onclick="exportAnalyticsData()">
                        <i class="fas fa-download me-1"></i>Export Data
                    </button>
                    <div class="btn-group btn-group-sm" id="analytics-tab-buttons">
                        <button class="btn btn-outline-primary active" onclick="changeAnalyticsView('overview', this)">Overview</button>
                        <button class="btn btn-outline-primary" onclick="changeAnalyticsView('category', this)">By Category</button>
                        <button class="btn btn-outline-primary" onclick="changeAnalyticsView('time', this)">Time Analysis</button>
                    </div>
                </div>
            </div>
                    <div class="card-body">
                        <!-- Overview Tab -->
                        <div id="analytics-overview" class="analytics-tab">
                            <div class="row">
                                <!-- Survey Completion Rates -->
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0">Survey Completion Rates</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="completion-chart">
                                                <!-- Completion bars will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Category Performance -->
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0">Category Performance</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="category-chart">
                                                <!-- Category performance will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <!-- Response Time Analysis -->
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0">Average Response Time</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="response-time-chart">
                                                <!-- Response time bars will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Student Engagement -->
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0">Student Engagement</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-center">
                                                <div class="display-4 text-primary" id="avg-surveys-per-student">0</div>
                                                <p class="text-muted">Average surveys per student</p>
                                            </div>
                                            <div class="mt-3">
                                                <small class="text-muted">Top engaged students:</small>
                                                <div id="top-students-list">
                                                    <!-- Top students will be listed here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Category Analysis Tab -->
                        <div id="analytics-category" class="analytics-tab d-none">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Category-wise Submissions</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="category-breakdown-chart">
                                                <!-- Category breakdown will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Category Insights</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="category-insights">
                                                <!-- Category insights will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Time Analysis Tab -->
                        <div id="analytics-time" class="analytics-tab d-none">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Submissions Over Time</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <select class="form-select" id="time-range-select" onchange="updateTimeAnalysis()">
                                                    <option value="7">Last 7 Days</option>
                                                    <option value="30" selected>Last 30 Days</option>
                                                    <option value="90">Last 90 Days</option>
                                                    <option value="365">Last Year</option>
                                                </select>
                                            </div>
                                            <div id="time-series-chart">
                                                <!-- Time series chart will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Peak Activity Times</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="peak-times-chart">
                                                <!-- Peak times will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Surveys List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">All Surveys</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showInactive">
                            <label class="form-check-label" for="showInactive">Show Inactive</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Organization</th>
                                        <th>Category</th>
                                        <th>Points</th>
                                        <th>Submissions</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="surveys-table-body">
                                    <!-- Surveys will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Survey Modal -->
    <div class="modal fade" id="surveyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="surveyModalTitle">Create New Survey</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="surveyForm">
                        <input type="hidden" id="surveyId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Survey Title</label>
                                    <input type="text" class="form-control" id="surveyTitle" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Organization</label>
                                    <input type="text" class="form-control" id="surveyOrganization" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="surveyDescription" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="surveyCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="waste-reduction">Waste Reduction</option>
                                        <option value="energy-conservation">Energy Conservation</option>
                                        <option value="water-preservation">Water Preservation</option>
                                        <option value="sustainable-living">Sustainable Living</option>
                                        <option value="biodiversity">Biodiversity</option>
                                        <option value="climate-action">Climate Action</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Points Reward</label>
                                    <input type="number" class="form-control" id="surveyPoints" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Duration</label>
                                    <input type="text" class="form-control" id="surveyDuration" value="10-15 minutes" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Target Audience</label>
                            <select class="form-select" id="surveyAudience" multiple>
                                <option value="student" selected>Students</option>
                                <option value="teacher">Teachers</option>
                                <option value="all">All Users</option>
                            </select>
                            <small class="text-muted">Hold Ctrl to select multiple options</small>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="surveyActive" checked>
                            <label class="form-check-label">Active Survey</label>
                        </div>

                        <!-- Questions Section -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Survey Questions</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addQuestion()">
                                    <i class="fas fa-plus me-1"></i>Add Question
                                </button>
                            </div>
                            <div id="questions-container">
                                <!-- Questions will be added here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveSurvey()">Save Survey</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submissions Modal -->
    <div class="modal fade" id="submissionsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Survey Submissions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="submissions-content">
                        <!-- Submissions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/script.js"></script>
    <script>
        let allSurveys = [];
        let questionCount = 0;
        let analyticsData = {};

        function displaySurveys() {
            const tbody = document.getElementById('surveys-table-body');
            const showInactive = document.getElementById('showInactive').checked;
            
            const filteredSurveys = showInactive ? allSurveys : allSurveys.filter(s => s.isActive);

            if (filteredSurveys.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p>No surveys found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredSurveys.map(survey => `
                <tr>
                    <td>
                        <strong>${survey.title}</strong>
                        <br><small class="text-muted">${survey.description.substring(0, 60)}...</small>
                    </td>
                    <td>${survey.organization}</td>
                    <td><span class="badge bg-info">${survey.category}</span></td>
                    <td><span class="badge bg-warning">${survey.points} pts</span></td>
                    <td>
                        <span class="badge bg-primary">${survey.totalSubmissions}</span>
                    </td>
                    <td>
                        <span class="badge ${survey.isActive ? 'bg-success' : 'bg-secondary'}">
                            ${survey.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewSubmissions('${survey._id}')" title="View Submissions">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="editSurvey('${survey._id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSurvey('${survey._id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStatistics() {
            const totalSurveys = allSurveys.length;
            const activeSurveys = allSurveys.filter(s => s.isActive).length;
            const totalSubmissions = allSurveys.reduce((sum, s) => sum + s.totalSubmissions, 0);
            const totalPoints = allSurveys.reduce((sum, s) => sum + (s.points * s.totalSubmissions), 0);

            document.getElementById('total-surveys').textContent = totalSurveys;
            document.getElementById('active-surveys').textContent = activeSurveys;
            document.getElementById('total-submissions').textContent = totalSubmissions;
            document.getElementById('total-points').textContent = totalPoints;
        }

        // Function to change analytics view
function changeAnalyticsView(view, element) {
    // Update active button
    const buttonGroup = element.closest('.btn-group');
    if (buttonGroup) {
        buttonGroup.querySelectorAll('.btn').forEach(btn => {
            btn.classList.remove('active');
        });
        element.classList.add('active');
    }

    // Show selected tab and hide others
    document.querySelectorAll('.analytics-tab').forEach(tab => {
        tab.classList.add('d-none');
    });
    
    const selectedTab = document.getElementById(`analytics-${view}`);
    if (selectedTab) {
        selectedTab.classList.remove('d-none');
    }

    // Load data for the view
    if (view === 'overview') {
        loadOverviewAnalytics();
    } else if (view === 'category') {
        loadCategoryAnalytics();
    } else if (view === 'time') {
        loadTimeAnalytics();
    }
}

// Function to initialize analytics
function initializeAnalytics() {
    // Set overview as default active tab
    const overviewTab = document.getElementById('analytics-overview');
    const categoryTab = document.getElementById('analytics-category');
    const timeTab = document.getElementById('analytics-time');
    
    if (overviewTab && !overviewTab.classList.contains('d-none')) {
        loadOverviewAnalytics();
    }
}

// Update the analytics header HTML to properly pass the element
// Replace the existing analytics header button group with this:
function updateAnalyticsHeaderHTML() {
    const analyticsHeader = document.querySelector('.card-header.bg-light .btn-group');
    if (analyticsHeader) {
        analyticsHeader.innerHTML = `
            <button class="btn btn-outline-primary active" onclick="changeAnalyticsView('overview', this)">Overview</button>
            <button class="btn btn-outline-primary" onclick="changeAnalyticsView('category', this)">By Category</button>
            <button class="btn btn-outline-primary" onclick="changeAnalyticsView('time', this)">Time Analysis</button>
        `;
    }
}

        // Function to calculate analytics from survey data
        function calculateAnalytics() {
            const data = {
                surveys: allSurveys,
                completionRates: {},
                categoryStats: {},
                timeData: {},
                studentEngagement: {},
                responseTimes: {}
            };

            // Calculate completion rates
            data.surveys.forEach(survey => {
                const completionRate = survey.totalSubmissions > 0 ? 
                    Math.round((survey.totalSubmissions / 100) * 100) : 0; // Assuming 100 as potential audience
                data.completionRates[survey._id] = {
                    title: survey.title,
                    rate: completionRate,
                    submissions: survey.totalSubmissions,
                    points: survey.points
                };
            });

            // Calculate category statistics
            const categories = ['waste-reduction', 'energy-conservation', 'water-preservation', 'sustainable-living', 'biodiversity', 'climate-action'];
            categories.forEach(cat => {
                const categorySurveys = data.surveys.filter(s => s.category === cat);
                data.categoryStats[cat] = {
                    surveyCount: categorySurveys.length,
                    totalSubmissions: categorySurveys.reduce((sum, s) => sum + s.totalSubmissions, 0),
                    totalPoints: categorySurveys.reduce((sum, s) => sum + (s.points * s.totalSubmissions), 0),
                    avgCompletion: categorySurveys.length > 0 ? 
                        Math.round(categorySurveys.reduce((sum, s) => sum + (s.totalSubmissions / 100 * 100), 0) / categorySurveys.length) : 0
                };
            });

            // Calculate time-based data (last 30 days)
            const last30Days = Array.from({ length: 30 }, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                return date.toISOString().split('T')[0];
            });

            data.timeData.dailySubmissions = last30Days.map(date => {
                let count = 0;
                data.surveys.forEach(survey => {
                    survey.submissions.forEach(sub => {
                        const subDate = new Date(sub.submittedAt).toISOString().split('T')[0];
                        if (subDate === date) count++;
                    });
                });
                return { date, count };
            });

            // Calculate peak hours
            data.timeData.peakHours = Array.from({ length: 24 }, (_, hour) => {
                let count = 0;
                data.surveys.forEach(survey => {
                    survey.submissions.forEach(sub => {
                        const subHour = new Date(sub.submittedAt).getHours();
                        if (subHour === hour) count++;
                    });
                });
                return { hour, count };
            });

            // Calculate student engagement
            const studentSubmissions = {};
            data.surveys.forEach(survey => {
                survey.submissions.forEach(sub => {
                    if (!studentSubmissions[sub.user._id]) {
                        studentSubmissions[sub.user._id] = {
                            user: sub.user,
                            count: 0,
                            totalPoints: 0
                        };
                    }
                    studentSubmissions[sub.user._id].count++;
                    studentSubmissions[sub.user._id].totalPoints += sub.pointsEarned;
                });
            });

            data.studentEngagement = Object.values(studentSubmissions)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            data.avgSurveysPerStudent = data.studentEngagement.length > 0 ?
                Math.round(data.studentEngagement.reduce((sum, s) => sum + s.count, 0) / data.studentEngagement.length * 10) / 10 : 0;

            // Calculate response times (mock data - in real app, track start and end times)
            data.surveys.forEach(survey => {
                data.responseTimes[survey._id] = {
                    title: survey.title,
                    avgTime: Math.random() * 10 + 5 // Random between 5-15 minutes
                };
            });

            analyticsData = data;
            return data;
        }

        // Load overview analytics
        function loadOverviewAnalytics() {
            const data = calculateAnalytics();

            // Render completion rates
            const completionChart = document.getElementById('completion-chart');
            completionChart.innerHTML = data.surveys.map(survey => {
                const completion = data.completionRates[survey._id];
                return `
                    <div class="survey-completion-item">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">${survey.title}</span>
                            <span class="badge bg-primary">${completion.submissions} submissions</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${completion.rate}%;" 
                                 aria-valuenow="${completion.rate}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                ${completion.rate}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render category performance
            const categoryChart = document.getElementById('category-chart');
            const categories = Object.keys(data.categoryStats);
            categoryChart.innerHTML = categories.map(cat => {
                const stats = data.categoryStats[cat];
                const width = Math.min((stats.totalSubmissions / Math.max(...categories.map(c => data.categoryStats[c].totalSubmissions)) * 100), 100);
                return `
                    <div class="chart-bar">
                        <div class="d-flex justify-content-between">
                            <span class="small text-capitalize">${cat.replace('-', ' ')}</span>
                            <span class="small">${stats.totalSubmissions} subs</span>
                        </div>
                        <div class="progress" style="height: 15px;">
                            <div class="progress-bar category-${cat}" role="progressbar" 
                                 style="width: ${width}%;" 
                                 aria-valuenow="${stats.totalSubmissions}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">${stats.surveyCount} surveys</small>
                            <small class="text-muted">${stats.totalPoints} points</small>
                        </div>
                    </div>
                `;
            }).join('');

            // Render response times
            const responseTimeChart = document.getElementById('response-time-chart');
            responseTimeChart.innerHTML = data.surveys.map(survey => {
                const responseTime = data.responseTimes[survey._id];
                return `
                    <div class="chart-bar">
                        <div class="d-flex justify-content-between">
                            <span class="small">${survey.title}</span>
                            <span class="small">${responseTime.avgTime.toFixed(1)} min</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: ${(responseTime.avgTime / 20 * 100)}%;" 
                                 aria-valuenow="${responseTime.avgTime}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="20">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render student engagement
            document.getElementById('avg-surveys-per-student').textContent = data.avgSurveysPerStudent;
            const topStudentsList = document.getElementById('top-students-list');
            topStudentsList.innerHTML = data.studentEngagement.map((student, index) => `
                <div class="d-flex justify-content-between align-items-center py-1">
                    <div>
                        <span class="badge bg-secondary analytics-badge">${index + 1}</span>
                        <small>${student.user.name}</small>
                    </div>
                    <div>
                        <span class="badge bg-success analytics-badge">${student.count} surveys</span>
                        <span class="badge bg-warning analytics-badge">${student.totalPoints} pts</span>
                    </div>
                </div>
            `).join('');
        }

        // Load category analytics
        function loadCategoryAnalytics() {
            const data = calculateAnalytics();
            
            // Category breakdown chart
            const categoryBreakdown = document.getElementById('category-breakdown-chart');
            const totalSubmissions = Object.values(data.categoryStats).reduce((sum, stats) => sum + stats.totalSubmissions, 0);
            
            categoryBreakdown.innerHTML = Object.keys(data.categoryStats).map(cat => {
                const stats = data.categoryStats[cat];
                const percentage = totalSubmissions > 0 ? Math.round((stats.totalSubmissions / totalSubmissions) * 100) : 0;
                
                return `
                    <div class="row align-items-center mb-3">
                        <div class="col-3">
                            <span class="text-capitalize">${cat.replace('-', ' ')}</span>
                        </div>
                        <div class="col-6">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar category-${cat}" role="progressbar" 
                                     style="width: ${percentage}%;" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${percentage}%
                                </div>
                            </div>
                        </div>
                        <div class="col-3 text-end">
                            <span class="badge bg-primary">${stats.totalSubmissions}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Category insights
            const categoryInsights = document.getElementById('category-insights');
            const topCategory = Object.keys(data.categoryStats).reduce((top, cat) => 
                data.categoryStats[cat].totalSubmissions > data.categoryStats[top].totalSubmissions ? cat : top
            , Object.keys(data.categoryStats)[0]);

            categoryInsights.innerHTML = `
                <div class="insight-card">
                    <div class="value text-primary">${data.categoryStats[topCategory].totalSubmissions}</div>
                    <div class="label">Most Popular Category</div>
                    <small class="text-capitalize">${topCategory.replace('-', ' ')}</small>
                </div>
                
                <div class="insight-card">
                    <div class="value text-success">${Math.max(...Object.values(data.categoryStats).map(s => s.avgCompletion))}%</div>
                    <div class="label">Highest Completion Rate</div>
                </div>
                
                <div class="insight-card">
                    <div class="value text-warning">${Object.keys(data.categoryStats).length}</div>
                    <div class="label">Active Categories</div>
                </div>
            `;
        }

        // Load time analytics
        function loadTimeAnalytics() {
            const data = calculateAnalytics();
            updateTimeAnalysis();
        }

        function updateTimeAnalysis() {
            const timeRange = parseInt(document.getElementById('time-range-select').value);
            const data = calculateAnalytics();
            
            // Filter data based on selected time range
            const filteredData = data.timeData.dailySubmissions.slice(-timeRange);
            
            // Time series chart
            const timeSeriesChart = document.getElementById('time-series-chart');
            const maxSubmissions = Math.max(...filteredData.map(d => d.count));
            
            timeSeriesChart.innerHTML = filteredData.map(day => {
                const height = maxSubmissions > 0 ? (day.count / maxSubmissions * 100) : 0;
                const date = new Date(day.date);
                const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                return `
                    <div class="d-inline-block text-center mx-1" style="width: 40px;">
                        <div class="bg-primary rounded-top" style="height: ${height}px; width: 30px; margin: 0 auto;"></div>
                        <small class="d-block mt-1">${day.count}</small>
                        <small class="d-block text-muted">${label}</small>
                    </div>
                `;
            }).join('');

            // Peak times chart
            const peakTimesChart = document.getElementById('peak-times-chart');
            const maxHourly = Math.max(...data.timeData.peakHours.map(h => h.count));
            
            peakTimesChart.innerHTML = data.timeData.peakHours.map(hourData => {
                const height = maxHourly > 0 ? (hourData.count / maxHourly * 100) : 0;
                const hourLabel = `${hourData.hour}:00`;
                
                return `
                    <div class="peak-time-item">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <small>${hourLabel}</small>
                                <small>${hourData.count}</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: ${height}%;" 
                                     aria-valuenow="${hourData.count}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="${maxHourly}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Export analytics data
        function exportAnalyticsData() {
            const data = calculateAnalytics();
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Survey Analytics Report\n\n"
                + "Category,Surveys,Submissions,Points,Avg Completion\n"
                + Object.keys(data.categoryStats).map(cat => 
                    `${cat.replace('-', ' ')},${data.categoryStats[cat].surveyCount},${data.categoryStats[cat].totalSubmissions},${data.categoryStats[cat].totalPoints},${data.categoryStats[cat].avgCompletion}%`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "survey_analytics.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showCreateSurveyModal() {
            document.getElementById('surveyModalTitle').textContent = 'Create New Survey';
            document.getElementById('surveyForm').reset();
            document.getElementById('surveyId').value = '';
            document.getElementById('questions-container').innerHTML = '';
            questionCount = 0;
            
            const modal = new bootstrap.Modal(document.getElementById('surveyModal'));
            modal.show();
        }

        function addQuestion() {
            questionCount++;
            const questionHtml = `
                <div class="question-item" id="question-${questionCount}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Question ${questionCount}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${questionCount})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" placeholder="Enter question" name="question" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select question-type" onchange="toggleQuestionOptions(${questionCount})">
                                <option value="multiple-choice">Multiple Choice</option>
                                <option value="checkbox">Checkbox</option>
                                <option value="scale">Scale</option>
                                <option value="text">Text</option>
                                <option value="number">Number</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="required-${questionCount}">
                                <label class="form-check-label" for="required-${questionCount}">Required</label>
                            </div>
                        </div>
                    </div>
                    <div class="question-options mt-2" id="options-${questionCount}">
                        <div class="option-item mb-1">
                            <input type="text" class="form-control" placeholder="Option 1">
                        </div>
                        <div class="option-item mb-1">
                            <input type="text" class="form-control" placeholder="Option 2">
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addOption(${questionCount})">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('questions-container').insertAdjacentHTML('beforeend', questionHtml);
        }

        function toggleQuestionOptions(questionId) {
            const optionsDiv = document.getElementById(`options-${questionId}`);
            const questionDiv = document.getElementById(`question-${questionId}`);
            const typeSelect = questionDiv.querySelector('.question-type');
            const type = typeSelect.value;

            if (type === 'multiple-choice' || type === 'checkbox') {
                optionsDiv.style.display = 'block';
            } else if (type === 'scale') {
                optionsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <input type="number" class="form-control" placeholder="Min" value="1">
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" placeholder="Max" value="5">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" placeholder="Labels (comma separated)" value="Poor, Fair, Good, Very Good, Excellent">
                        </div>
                    </div>
                `;
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
        }

        function addOption(questionId) {
            const optionsDiv = document.getElementById(`options-${questionId}`);
            const optionCount = optionsDiv.querySelectorAll('.option-item').length + 1;
            const newOption = document.createElement('div');
            newOption.className = 'option-item mb-1';
            newOption.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Option ${optionCount}">
                    <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            optionsDiv.insertBefore(newOption, optionsDiv.lastElementChild);
        }

        function removeQuestion(questionId) {
            const questionDiv = document.getElementById(`question-${questionId}`);
            questionDiv.remove();
            // Renumber remaining questions
            questionCount--;
        }

        async function saveSurvey() {
            try {
                const formData = {
                    title: document.getElementById('surveyTitle').value,
                    description: document.getElementById('surveyDescription').value,
                    organization: document.getElementById('surveyOrganization').value,
                    category: document.getElementById('surveyCategory').value,
                    points: parseInt(document.getElementById('surveyPoints').value),
                    duration: document.getElementById('surveyDuration').value,
                    targetAudience: Array.from(document.getElementById('surveyAudience').selectedOptions).map(opt => opt.value),
                    isActive: document.getElementById('surveyActive').checked,
                    questions: []
                };

                // Collect questions
                const questionItems = document.querySelectorAll('.question-item');
                questionItems.forEach(item => {
                    const question = {
                        question: item.querySelector('input[name="question"]').value,
                        type: item.querySelector('.question-type').value,
                        required: item.querySelector('input[type="checkbox"]').checked
                    };

                    if (question.type === 'multiple-choice' || question.type === 'checkbox') {
                        const options = Array.from(item.querySelectorAll('.option-item input')).map(input => input.value).filter(val => val);
                        question.options = options;
                    } else if (question.type === 'scale') {
                        const inputs = item.querySelectorAll('input');
                        question.min = parseInt(inputs[1].value) || 1;
                        question.max = parseInt(inputs[2].value) || 5;
                        question.labels = inputs[3].value.split(',').map(l => l.trim());
                    }

                    formData.questions.push(question);
                });

                const surveyId = document.getElementById('surveyId').value;
                let response;

                if (surveyId) {
                    response = await apiCall(`/surveys/admin/${surveyId}`, {
                        method: 'PUT',
                        body: formData
                    });
                } else {
                    response = await apiCall('/surveys/admin', {
                        method: 'POST',
                        body: formData
                    });
                }

                alert('Survey saved successfully!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('surveyModal'));
                modal.hide();
                loadSurveys();

            } catch (error) {
                console.error('Error saving survey:', error);
                alert('Error saving survey: ' + error.message);
            }
        }

        async function viewSubmissions(surveyId) {
            try {
                const response = await apiCall(`/surveys/admin/${surveyId}/submissions`);
                const data = response.data;
                
                let submissionsHtml = `
                    <h6>${data.survey.title}</h6>
                    <p class="text-muted">${data.survey.description}</p>
                    <hr>
                `;

                if (data.submissions.length === 0) {
                    submissionsHtml += '<p class="text-center text-muted">No submissions yet</p>';
                } else {
                    submissionsHtml += data.submissions.map((sub, index) => `
                        <div class="submission-item card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Submission ${index + 1}</h6>
                                    <small class="text-muted">${new Date(sub.submittedAt).toLocaleDateString()}</small>
                                </div>
                                <p class="mb-2"><strong>User:</strong> ${sub.user.name} (${sub.user.email})</p>
                                <p class="mb-2"><strong>School:</strong> ${sub.user.school || 'Not specified'}</p>
                                <p class="mb-2"><strong>Points Earned:</strong> ${sub.pointsEarned}</p>
                                <div class="responses">
                                    <strong>Responses:</strong>
                                    <pre class="mt-2 p-2 bg-light rounded">${JSON.stringify(sub.responses, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                document.getElementById('submissions-content').innerHTML = submissionsHtml;
                const modal = new bootstrap.Modal(document.getElementById('submissionsModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading submissions:', error);
                alert('Error loading submissions: ' + error.message);
            }
        }

        async function editSurvey(surveyId) {
            try {
                const survey = allSurveys.find(s => s._id === surveyId);
                if (!survey) return;

                document.getElementById('surveyModalTitle').textContent = 'Edit Survey';
                document.getElementById('surveyId').value = survey._id;
                document.getElementById('surveyTitle').value = survey.title;
                document.getElementById('surveyDescription').value = survey.description;
                document.getElementById('surveyOrganization').value = survey.organization;
                document.getElementById('surveyCategory').value = survey.category;
                document.getElementById('surveyPoints').value = survey.points;
                document.getElementById('surveyDuration').value = survey.duration;
                document.getElementById('surveyActive').checked = survey.isActive;

                // Set target audience
                const audienceSelect = document.getElementById('surveyAudience');
                Array.from(audienceSelect.options).forEach(option => {
                    option.selected = survey.targetAudience.includes(option.value);
                });

                // Load questions
                document.getElementById('questions-container').innerHTML = '';
                questionCount = 0;
                
                survey.questions.forEach(question => {
                    questionCount++;
                    // Add question HTML similar to addQuestion() but with pre-filled data
                    // Implementation similar to addQuestion but with data population
                });

                const modal = new bootstrap.Modal(document.getElementById('surveyModal'));
                modal.show();

            } catch (error) {
                console.error('Error editing survey:', error);
                alert('Error loading survey for editing: ' + error.message);
            }
        }

        async function deleteSurvey(surveyId) {
            if (!confirm('Are you sure you want to delete this survey? This action cannot be undone.')) {
                return;
            }

            try {
                await apiCall(`/surveys/admin/${surveyId}`, {
                    method: 'DELETE'
                });
                alert('Survey deleted successfully!');
                loadSurveys();
            } catch (error) {
                console.error('Error deleting survey:', error);
                alert('Error deleting survey: ' + error.message);
            }
        }
// Mobile-specific enhancements
function initMobileEnhancements() {
    // Handle touch events for better mobile experience
    if ('ontouchstart' in window) {
        // Add touch feedback to buttons
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Improve dropdown touch experience
        const dropdowns = document.querySelectorAll('.dropdown-toggle');
        dropdowns.forEach(dropdown => {
            dropdown.addEventListener('touchstart', function(e) {
                // Prevent immediate click on dropdown toggle
                e.preventDefault();
                const dropdownMenu = this.nextElementSibling;
                const isOpen = dropdownMenu.classList.contains('show');
                
                // Close all other dropdowns
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
                
                // Toggle current dropdown
                if (!isOpen) {
                    dropdownMenu.classList.add('show');
                }
            }, {passive: false});
        });
        
        // Close dropdown when clicking outside on touch devices
        document.addEventListener('touchstart', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
    }
    
    // Handle window resize for mobile optimizations
    window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
            document.body.classList.add('mobile-view');
        } else {
            document.body.classList.remove('mobile-view');
        }
    });
    
    // Initialize mobile view class
    if (window.innerWidth <= 768) {
        document.body.classList.add('mobile-view');
    }
}

// Update the existing DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    if (!checkLogin() || getCurrentUser().role !== 'admin') {
        window.location.href = 'login.html';
        return;
    }

    // Update analytics header HTML
    updateAnalyticsHeaderHTML();
    
    loadSurveys();
    document.getElementById('showInactive').addEventListener('change', displaySurveys);
    
    // Initialize mobile enhancements
    initMobileEnhancements();
    
    // Initialize analytics after a short delay to ensure DOM is ready
    setTimeout(() => {
        initializeAnalytics();
    }, 100);
});

// Update the loadSurveys function to reinitialize analytics
async function loadSurveys() {
    try {
        const response = await apiCall('/surveys/admin/all');
        allSurveys = response.data;
        displaySurveys();
        updateStatistics();
        
        // Reinitialize analytics with new data
        initializeAnalytics();
    } catch (error) {
        console.error('Error loading surveys:', error);
        alert('Error loading surveys: ' + error.message);
    }
}
// Update UI based on login status with profile dropdown
function updateUIForLoginStatus() {
    const user = getCurrentUser();
    const authButtons = document.getElementById('auth-buttons');
    const userMenu = document.getElementById('user-menu');
    
    if (user) {
        // Hide auth buttons, show user menu
        if (authButtons) authButtons.style.display = 'none';
        if (userMenu) userMenu.style.display = 'block';
        
        // Update user information in dropdown
        updateUserDropdown(user);
        
        // Show/hide role-specific links
        toggleRoleSpecificLinks(user.role);
        
    } else {
        // Show auth buttons, hide user menu
        if (authButtons) authButtons.style.display = 'flex';
        if (userMenu) userMenu.style.display = 'none';
    }
}

// Update dropdown with user information
function updateUserDropdown(user) {
    // Navbar elements
    const navbarUsername = document.getElementById('navbar-username');
    const navbarAvatar = document.getElementById('navbar-avatar');
    
    // Dropdown elements
    const dropdownUsername = document.getElementById('dropdown-username');
    const dropdownEmail = document.getElementById('dropdown-email');
    const dropdownAvatar = document.getElementById('dropdown-avatar');
    const dropdownRole = document.getElementById('dropdown-role');
    
    if (navbarUsername) navbarUsername.textContent = user.name || 'User';
    if (dropdownUsername) dropdownUsername.textContent = user.name || 'User';
    if (dropdownEmail) dropdownEmail.textContent = user.email || '';
    
    // Update avatars based on role
    const avatarColor = getAvatarColorByRole(user.role);
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'User')}&background=${avatarColor}&color=fff&size=`;
    
    if (navbarAvatar) navbarAvatar.src = avatarUrl + '32';
    if (dropdownAvatar) dropdownAvatar.src = avatarUrl + '64';
    
    // Update role badge
    if (dropdownRole) {
        dropdownRole.textContent = user.role || 'Student';
        dropdownRole.className = 'badge user-role-badge ' + getRoleBadgeClass(user.role);
    }
}

// Get avatar background color based on role
function getAvatarColorByRole(role) {
    const colors = {
        'student': '20c997',
        'teacher': '6f42c1', 
        'admin': 'dc3545'
    };
    return colors[role] || '27ae60';
}

// Get badge class based on role
function getRoleBadgeClass(role) {
    const classes = {
        'student': 'student-badge',
        'teacher': 'teacher-badge',
        'admin': 'admin-badge'
    };
    return classes[role] || 'student-badge';
}

// Show/hide role-specific links
function toggleRoleSpecificLinks(role) {
    const teacherAdminLinks = document.getElementById('teacher-admin-links');
    const teacherDashboardLink = document.getElementById('teacher-dashboard-link');
    const adminPanelLink = document.getElementById('admin-panel-link');
    
    if (teacherAdminLinks) {
        if (role === 'teacher' || role === 'admin') {
            teacherAdminLinks.style.display = 'block';
        } else {
            teacherAdminLinks.style.display = 'none';
        }
    }
    
    // Show/hide specific links based on role
    if (teacherDashboardLink) {
        teacherDashboardLink.style.display = role === 'teacher' ? 'block' : 'none';
    }
    
    if (adminPanelLink) {
        adminPanelLink.style.display = role === 'admin' ? 'block' : 'none';
    }
}

// Enhanced logout function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('user');
        localStorage.removeItem('token');
        window.location.href = 'index.html';
    }
}

// Initialize dropdown on page load
document.addEventListener('DOMContentLoaded', function() {
    updateUIForLoginStatus();
    
    // Update dropdown when user data changes
    window.addEventListener('storage', function(e) {
        if (e.key === 'user') {
            const user = getCurrentUser();
            if (user) {
                updateUserDropdown(user);
            }
        }
    });
});
    </script>
</body>
</html>